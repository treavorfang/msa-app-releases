erDiagram
    %% Core Entities
    ROLE ||--o{ ROLE_PERMISSION : "has"
    ROLE_PERMISSION }o--|| PERMISSION : "includes"
    ROLE ||--o{ USER : "assigned_to"
    USER ||--o{ CUSTOMER : "created_by"
    USER ||--o{ TECHNICIAN : "created_by"
    USER ||--o{ SUPPLIER : "created_by"
    USER ||--o{ TICKET : "opens"
    USER ||--o{ INVOICE : "generates"
    USER ||--o{ AUDIT_LOG : "triggers"

    %% Customer/Device Flow
    CUSTOMER ||--o{ DEVICE : "owns"
    CUSTOMER ||--o{ WARRANTY : "has"
    DEVICE ||--o{ TICKET : "has_tickets"
    DEVICE ||--o{ WARRANTY : "covered_by"
    DEVICE ||--o{ REPAIR_HISTORY : "has"

    %% Repair Process
    TECHNICIAN ||--o{ TICKET : "assigned_to"
    TECHNICIAN ||--o{ WORK_LOG : "logs_time"
    TECHNICIAN ||--o{ REPAIR_PART : "installs"
    TICKET ||--o{ STATUS_HISTORY : "has_history"

    %% Inventory Management
    SUPPLIER ||--o{ PART : "provides"
    PART ||--o{ REPAIR_PART : "used_in"
    PART ||--o{ INVENTORY_LOG : "history"
    PART ||--o{ PURCHASE_ORDER : "ordered_in"

    %% Financials
    PAYMENT ||--|| INVOICE : "settles"
    INVOICE ||--o{ INVOICE_ITEM : "contains"

    %% Entities
    ROLE {
        int id PK
        string name "admin|manager|technician|front_desk"
        string description
        datetime created_at
    }

    PERMISSION {
        int id PK
        string code
        string description
    }

    ROLE_PERMISSION {
        int role_id FK
        int permission_id FK
    }

    USER {
        int id PK
        string username
        string full_name
        string email
        string password_hash
        bool is_active
        datetime last_login
        datetime created_at
        datetime updated_at
        int role_id FK
    }

    AUDIT_LOG {
        int id PK
        int user_id FK
        string action
        json old_data
        json new_data
        string ip_address
        string table_name
        datetime created_at
    }

    CUSTOMER {
        int id PK
        string name
        string phone
        string email
        string address
        enum preferred_contact_method
        string notes
        datetime created_at
        datetime updated_at
        int created_by FK
        int updated_by FK
    }

    DEVICE {
        int id PK
        string brand
        string model
        string serial_number
        string imei
        string color
        string condition
        enum status
        string barcode
        datetime received_at
        datetime completed_at
        int customer_id FK
    }

    TICKET {
        int id PK
        string ticket_number
        int customer_id FK
        int device_id FK
        int created_by FK
        datetime created_at
        enum status
        enum priority
        string error
        string error_description
        string internal_notes
        decimal estimated_cost
        decimal actual_cost
        decimal deposit_paid
        int assigned_technician_id FK
        datetime deadline
        datetime completed_at
        bool warranty_covered
        int approved_by FK
    }

    STATUS_HISTORY {
        int id PK
        int ticket_id FK
        string old_status
        string new_status
        string reason
        int changed_by FK
        datetime changed_at
    }

    WARRANTY {
        int id PK
        string type
        string terms
        datetime start_date
        datetime end_date
        enum status
        int device_id FK
        int ticket_id FK
        int supplier_id FK
    }

    TECHNICIAN {
        int id PK
        int user_id FK
        string certification
        string specialization
        decimal salary
        decimal commission_rate
        bool is_active
        datetime joined_at
        int created_by FK
        int updated_by FK
    }

    WORK_LOG {
        int id PK
        int technician_id FK
        int ticket_id FK
        datetime start_time
        datetime end_time
        string work_performed
    }

    PART {
        int id PK
        string sku
        string name
        string brand
        string model_compatibility
        string category
        decimal cost_price
        int min_stock_level
        int current_stock
        string barcode
        int supplier_id FK
        bool is_active
    }

    REPAIR_PART {
        int id PK
        int ticket_id FK
        int part_id FK
        int technician_id FK
        int quantity
        datetime installed_at
        string warranty_terms
        datetime warranty_ends
    }

    INVOICE {
        int id PK
        string invoice_number
        decimal subtotal
        decimal tax
        decimal discount
        decimal total
        enum payment_status
        datetime due_date
        datetime paid_date
        int created_by FK
        datetime created_at
    }

    INVOICE_ITEM {
        int id PK
        int invoice_id FK
        int item_id
        string item_type
        decimal quantity
        decimal unit_price
        decimal total
    }

    PAYMENT {
        int id PK
        int invoice_id FK
        decimal amount
        string payment_method
        string transaction_id
        string notes
        datetime paid_at
        int received_by FK
    }

    SUPPLIER {
        int id PK
        string name
        string contact_person
        string email
        string phone
        string address
        string tax_id
        string payment_terms
        string notes
        datetime created_at
        int created_by FK
    }

    PURCHASE_ORDER {
        int id PK
        string po_number
        int supplier_id FK
        enum status
        datetime order_date
        datetime expected_delivery
        datetime received_date
        decimal total_amount
        string notes
        int created_by FK
    }

    INVENTORY_LOG {
        int id PK
        int part_id FK
        enum action_type
        int quantity
        int reference_id
        string reference_type
        string notes
        datetime logged_at
        int logged_by FK
    }

    REPAIR_HISTORY {
        int id PK
        int device_id FK
        int ticket_id FK
        datetime repair_date
        string repair_summary
        decimal total_cost
        bool warranty_used
    }
